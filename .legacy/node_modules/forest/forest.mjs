function e(e,t){e.cursor[t].prev&&(e.cursor[t].prev.cursor[t].next=e.cursor[t].next),e.cursor[t].next&&(e.cursor[t].next.cursor[t].prev=e.cursor[t].prev),e.queue[t].last===e&&(e.queue[t].last=e.cursor[t].prev),e.queue[t].first===e&&(e.queue[t].first=e.cursor[t].next),e.cursor[t].prev=null,e.cursor[t].next=null}function t(e){var t,l;e.status='active',t=a(e),(l=e).cursor.prev&&(l.cursor.prev.cursor.next=l.cursor.next),l.cursor.next&&(l.cursor.next.cursor.prev=l.cursor.prev),t.last===l&&(t.last=l.cursor.prev),t.first===l&&(t.first=l.cursor.next),l.cursor.prev=null,l.cursor.next=null}function a(e){return e.group.activeChilds[e.priority]}function l(e,a){a.value.active=a.value.pending=e,'active'!==a.status&&t(a)}function n(l,n){if(n.value.active===l)return n.value.pending=l,void('pending'===n.status&&(t(n),a(n).first||e(n.group,n.priority)));var r,o,i,s;'active'===n.status&&(n.status='pending',a(n).first||((i=n.group).queue[s=n.priority].last?(i.cursor[s].prev=i.queue[s].last,i.queue[s].last.cursor[s].next=i,i.queue[s].last=i):i.queue[s].first=i.queue[s].last=i),o=n,(r=a(n)).last?(o.cursor.prev=r.last,r.last.cursor.next=o,r.last=o):r.first=r.last=o),n.value.pending=l,n.group.queue.rafID||(n.group.queue.rafID=Oe(n.group.queue.execQueue))}function r(a){Ce('execQueue');let l,n,r=Ie(),o=0;e:for(;a.props.first||a.tree.first||a.data.first;){if(Ie()-r>=1e3){o=1;break e}let i=!!a.props.first;for(i&&Ce('props');l=a.props.first;){for(;n=l.activeChilds.props.first;){if(Ie()-r>=1e3){o=1,Te('props');break e}n.runOp(n.value.pending),n.value.active=n.value.pending,t(n)}e(l,'props')}i&&Te('props');let s=!!a.tree.first;for(s&&Ce('tree');l=a.tree.first;){for(;n=l.activeChilds.tree.first;){if(Ie()-r>=1e3){o=1,Te('tree');break e}n.runOp(n.value.pending),n.value.active=n.value.pending,t(n)}e(l,'tree')}s&&Te('tree');let c=!!a.data.first;for(c&&Ce('data');l=a.data.first;){for(;n=l.activeChilds.data.first;){if(Ie()-r>=1e3){o=1,Te('data');break e}n.runOp(n.value.pending),n.value.active=n.value.pending,t(n)}e(l,'data')}c&&Te('data')}if(Te('execQueue'),o)a.rafID=Oe(a.execQueue);else if(a.rafID=null,a.onDrain){let e=a.onDrain;a.onDrain=null,e()}}function o({value:e,runOp:t,group:a,priority:l}){return{value:{active:e,pending:e},runOp:t,status:'active',priority:l,group:a,cursor:{prev:null,next:null}}}function i({onComplete:e}){let t={props:{first:null,last:null},tree:{first:null,last:null},data:{first:null,last:null},rafID:null,execQueue(){},onDrain:e};return t.execQueue=r.bind(null,t),t}function s(e){return{ops:[],queue:e,activeChilds:{props:{first:null,last:null},tree:{first:null,last:null},data:{first:null,last:null}},cursor:{props:{prev:null,next:null},tree:{prev:null,next:null},data:{prev:null,next:null}}}}function c({value:e,group:t,onInit:a,onChange:l}){let r=o({value:e,group:t,runOp(e){i.status='A',l(e)},priority:'data'}),i={status:'IA',value:r.value,ops:{init:o({value:0,group:t,runOp(e){i.status='A',a(i.value.active)},priority:'data'}),change:r,terminate:o({value:0,group:t,runOp(e){i.status='T'},priority:'data'})}};return n(1,i.ops.init),i}function u(e){switch(e.status){case'I':case'T':case'AT':return;case'A':e.status='AT',n(1,e.ops.terminate);break;case'AA':e.status='AT',n(1,e.ops.terminate),n(e.value.active,e.ops.change);break;case'IA':e.status='T',n(0,e.ops.init)}}function p(e,t){switch(t.status){case'I':case'T':return;case'A':t.value.active!==e&&(t.status='AA',n(e,t.ops.change));break;case'AA':t.value.active===e?(t.status='A',n(e,t.ops.change)):t.value.pending!==e&&(t.value.pending=e);break;case'IA':t.value.active=t.value.pending=e}}function d(e){switch(e=String(e)){case'__proto__':case'__defineGetter__':case'__defineSetter__':case'constructor':case'prototype':case'hasOwnProperty':case'toString':case'valueOf':case'setProperty':case'removeProperty':return'forbidden';default:return e.replace(/[^a-zA-Z0-9\-_]/g,'')}}function f(e,t){for(let a=0;a<t.length;a++){let{type:l,field:n,value:r}=t[a];qe[l](e,n,r)}}function m(e){return''!==e&&0!==e&&'0'!==e&&(0==e||null==e)}function v(e,t,a){m(a)?e.style.removeProperty(`--${t}`):e.style.setProperty(`--${t}`,`${a}`)}function h(e,t,a){m(a)?delete e.style[t]:e.style[t]=`${a}`}function g(e,t,a){m(a)?delete e.dataset[t]:e.dataset[t]=`${a}`}function b(e,t,a){if(m(a)){switch(t){case'value':delete e.value;break;case'checked':e.checked=0;break;case'spellcheck':if(0==a)return void e.setAttribute('spellcheck','false')}e.removeAttribute(t)}else{switch(t){case'value':e.value=`${a}`;break;case'checked':e.checked=`${a}`}e.setAttribute(t,`${a}`)}}function y(e,t){e.replaceData(0,(e.textContent||'').length,String(t))}function k({fn:e,state:t={},defer:a=0,name:l="",draft:n,isSvgRoot:r,namespace:o,env:i,isBlock:s=0}){let c=Be,u={id:++Pe,name:l,plain:[],watch:[],nameMap:{},pages:[],closure:[],childTemplates:[],handlers:Ae,upward:ue.filter({fn(e,t,a){if(!a.page){if(!a.parent||!a.parent.page)return 1;a.page=a.parent.page}if(!a.page.root.activeSpawns.has(a.page.fullID))return console.count('inactive page upward'),0;let l=[a.page.template],n=[a.page];{let e=a.page.parent;for(;e;)n.push(e),l.push(e.template),e=e.parent}return a.node.next.forEach((t=>{let r=t.meta.nativeTemplate;if(r)if(l.includes(r)){let o=n[l.indexOf(r)];pe({target:t,params:e,defer:1,page:o,stack:a,scope:a.scope})}else console.error('context drift',{stack:a,node:t});else pe({target:t,params:e,defer:1,page:a.page,stack:a,scope:a.scope})})),0}}),loader:ue.filter({fn(e,t,a){if(a.parent){let t=a.scope?a.scope.graphite.id:null;if(a.page){if(!a.page.root.activeSpawns.has(a.page.fullID))return console.count('inactive page loader'),0;if(a.page.template===u)return 1;if(a.page.root.childSpawns[a.page.fullID][u.id])a.page.root.childSpawns[a.page.fullID][u.id].forEach((l=>{(!t||l.root.scope&&t===l.root.scope.graphite.id)&&pe({params:e,target:a.node,page:l,defer:1,scope:a.scope})}));else{let l=a.page.fullID,n='rec'===a.page.template.name;u.pages.forEach((r=>{if(!t||r.root.scope&&t===r.root.scope.graphite.id)if(r.fullID===l||r.fullID.startsWith(`${l}_`)){let t=1;if(n){let e=a.page.template.id,l=r.parent;for(;l&&l!==a.page;){if(l.template.id===e){t=0;break}l=l.parent}}t&&pe({params:e,target:a.node,page:r,defer:1,scope:a.scope})}else l.startsWith(`${r.fullID}_`)&&pe({params:e,target:a.node,page:a.page,defer:1,scope:a.scope})}))}}else u.pages.forEach((l=>{(!t||l.root.scope&&t===l.root.scope.graphite.id)&&pe({params:e,target:a.node,page:l,defer:1,scope:a.scope})}));return 0}return 1}}),parent:c,node:null,api:null,trigger:{mount:de({named:'mount'})},draft:n,isSvgRoot:r,namespace:o,env:i,isBlock:s||!(!c||!c.isBlock)};c&&c.childTemplates.push(u);let p=fe({meta:{template:u}});return u.node=p,Be=u,a?u.deferredInit=()=>{let a=Be;Be=u,u.deferredInit=null;try{me(p,(()=>{let a=ve(t);u.api=e(a,u.trigger),u.nameMap=a}))}finally{Be=a}}:me(p,(()=>{let a=ve(t);u.api=e(a,u.trigger),u.nameMap=a})),Be=c,u}function I(e,t){let a;switch(a=t?t.getState(e):e.current,e.type){case'list':return[...a];case'shape':return{...a};default:return a}}function x(e,t,a){let l=t;for(;l&&!Ee(l,e);)l=l.parent;return l?Ee(l,e):a?(a.getState(e),a.reg[e.id]):e}function w(e,t){Ee(t,e)||(t.reg[e.id]=x(e,t.parent,t.root.scope))}function S(e,t,a){t in a||(a[t]=[]),a[t].push(...e)}function D(e,{values:t={},parentLeaf:a,mountNode:l,svgRoot:n,leafData:r,opGroup:o,domSubtree:i,hydration:s,root:c}){function u(e){if(e.before)for(let t=0;t<e.before.length;t++){let a=e.before[t];switch(a.type){case'map':{let t,l=a.from;if(!a.fn&&!l)break;l&&(w(l,f),t=d[l.id].current),d[e.id].current=a.fn?a.fn(t):t;break}case'field':{let t=a.from;w(t,f),d[e.id].current[a.field]=d[t.id].current;break}case'closure':w(a.of,f)}}}function p(e,t,a){let l;t.stop=1;try{for(;t.i<e.length;)l=e[t.i],t.i++,l.fn(a[l.of.id]?a[l.of.id].current:x(l.of,f.parent,f.root.scope).current)}catch(e){console.error(e),t.stop=0}}let d={},f={draft:e.draft,svgRoot:n,data:r,parent:a,hydration:s,mountNode:l,root:c,id:++Ne,fullID:'',reg:d,template:e};e.pages.push(f);let m=Me;Me=f,a&&S([f],e.id,c.childSpawns[a.fullID]),f.fullID=a?`${a.fullID}_${f.id}`:`${f.id}`,c.childSpawns[f.fullID]={},c.activeSpawns.add(f.fullID),c.leafOps[f.fullID]={group:o,domSubtree:i};for(let t=0;t<e.closure.length;t++){let a=e.closure[t],l=a,n=f.parent;e:for(;n;){if(Ee(n,a)){l=Ee(n,a);break e}n=n.parent}!n&&c.scope&&(c.scope.getState(a),l=c.scope.reg[a.id]),d[a.id]=l}for(let t=0;t<e.plain.length;t++){let a=e.plain[t],l={id:a.id,current:I(a,c.scope)};d[a.id]=l}for(let a in t){let l=e.nameMap[a].stateRef.id;d[l]={id:l,current:t[a]}}e.closure.forEach(u),e.plain.forEach(u);let v={i:0,stop:0};for(;!v.stop;)p(e.watch,v,d);if(a)for(let e in c.childSpawns[f.fullID])S(c.childSpawns[f.fullID][e],e,c.childSpawns[a.fullID]);if(Fe)Fe.steps.push({target:e.trigger.mount,params:f,defer:1,page:f,scope:c.scope});else{let t;Fe={parent:Fe,steps:[{target:e.trigger.mount,params:f,defer:1,page:f,scope:c.scope}]};do{for(;t=Fe.steps.shift();)Fe={parent:Fe,steps:[]},pe(t)}while(Fe=Fe.parent)}return Me=m,f}function C(e){let t=e.parent;for(;'element'!==t.type&&'using'!==t.type;)t=t.parent;return t?t.value:null}function T(e){if(!e.visible)return null;switch(e.type){case'text':case'element':return e;case'LF':case'route':case'rec':case'recItem':case'block':case'blockItem':for(let t=e.child.length-1;t>=0;t--){let a=T(e.child[t]);if(a)return a}return null;case'list':{let t=e.lastChild;if(!t)return null;for(;t;){let e=T(t);if(e)return e;t=t.left}return null}default:return null}}function O(e){switch(e.type){case'using':return null;case'LF':{let t=e.left;for(;t;){let e=T(t);if(e)return e;t=t.left}return O(e.parent)}case'element':case'text':case'route':case'rec':case'recItem':case'block':case'blockItem':case'list':{let t=e.parent;for(let a=e.index-1;a>=0;a--){let e=t.child[a];if(!e)continue;let l=T(e);if(l)return l}switch(t.type){case'element':case'using':return null}return O(t)}default:return null}}function q(e){let t=O(e);return t?t.value:null}function R(e,t){if(!e)throw Error(t)}function A(e,t){if(!e)throw Error(`${t}() called outside from using() closure`)}function P(e){if(!Be)return;let{draft:t}=e;if('listItem'!==t.type&&'rec'!==t.type)switch(Be.draft.type){case'element':case'using':case'route':case'list':case'rec':case'recItem':case'block':case'blockItem':t.inParentIndex=Be.draft.childCount,Be.draft.childCount+=1,Be.draft.childTemplates.push(e);break;default:console.warn(`unexpected currentTemplate type ${Be.draft.type}`)}}function N(e,{parentBlockFragment:t,leaf:a,node:l,svgRoot:n,values:r}){e.childTemplates.forEach((e=>{B({parentBlockFragment:t,leaf:a,node:l,svgRoot:n,values:r,actor:e})}))}function B({parentBlockFragment:e,leaf:t,node:a=t.mountNode,actor:l,svgRoot:n,values:r}){let i;R(_e.includes(e.type),`incorrect parent ${e.type}`);let{draft:c}=l,{queue:u}=t.root.leafOps[t.fullID].group,p=s(u),d=t.root.leafOps[t.fullID].domSubtree,m=d;switch(c.type){case'route':{let t={type:'route',parent:e,child:[],visible:0,index:c.inParentIndex};e.child[c.inParentIndex]=t,i={type:'route',block:t,ops:{},initialized:0,pendingInit:null};break}case'element':{let a;if(l.isBlock){let e,l,n=t;for(;n&&(!l||!e);){n.template.env&&(e=n.template.env);let{draft:t}=n;'element'===t.type&&('svg'===t.tag?l='svg':'foreignObject'===t.tag&&(l='html')),n=n.parent}l||(l='html'),e&&(a='svg'===l?e.document.createElementNS('http://www.w3.org/2000/svg',c.tag):e.document.createElement(c.tag),f(a,c.staticSeq))}else a=c.stencil.cloneNode();let n={type:'element',parent:e,child:[],value:a,visible:0,index:c.inParentIndex};e.child[c.inParentIndex]=n,i={type:'element',block:n,ops:{visible:o({value:0,priority:'tree',runOp(e){if(e){M(n);let e=i;e.needToCallNode&&(e.needToCallNode=0,pe({target:$e,params:{element:n.value,fns:c.node},page:v,scope:t.root.scope})),n.visible=1}else n.value.remove(),n.visible=0},group:d})},needToCallNode:c.node.length>0},m=s(u);break}case'list':{let t={type:'list',parent:e,child:[],lastChild:null,visible:1,index:c.inParentIndex};e.child[c.inParentIndex]=t,i={type:'list',draft:c,block:t,records:[],pendingUpdate:null};break}case'using':case'listItem':break;case'rec':{let t={type:'rec',parent:e,child:[],visible:1,index:c.inParentIndex};e.child[c.inParentIndex]=t,i={type:'rec',block:t};break}case'recItem':{let t={type:'recItem',parent:e,child:[],visible:1,index:c.inParentIndex};e.child[c.inParentIndex]=t,i={type:'rec item',block:t};break}case'block':{let t={type:'block',parent:e,child:[],visible:1,index:c.inParentIndex};e.child[c.inParentIndex]=t,i={type:'block',block:t};break}case'blockItem':{let t={type:'blockItem',parent:e,child:[],visible:1,index:c.inParentIndex};e.child[c.inParentIndex]=t,i={type:'block item',block:t};break}default:console.warn(`unexpected draft type ${c.type}`)}let v=D(l,{values:r,parentLeaf:t,mountNode:a,svgRoot:n||t.svgRoot,leafData:i,opGroup:p,domSubtree:m,hydration:t.hydration,root:t.root})}function M(e){let t=q(e);t?t.after(e.value):C(e).prepend(e.value),e.visible=1}function E({mount:e,state:t,onMount:a,onState:l}){return{onMount:he({source:t,clock:e,fn:a,greedy:1}),onState:he({source:e,clock:t,fn:l,greedy:1})}}function F(e,t){for(let a in e)t(e[a],a)}function _(e,t){if(!Be)return;let a=Be.draft;R('element'===a.type,`"handler" extension can be used only with element nodes, got "${a.type}"`),void 0===t&&(t=e,e={});for(let e in t)R(ge.unit(t[e]),`handler for "${e}" should be event`);let{passive:l=0,capture:n=0,prevent:r=0,stop:o=0}=e;a.handler.push({options:{prevent:r,stop:o},domConfig:{passive:r?0:l,capture:n},map:t})}function $(e){A(Be,'spec');let t=Be.draft;switch(t.type){case'list':return void(e.visible&&(t.itemVisible=e.visible));case'listItem':case'using':case'route':case'rec':case'recItem':case'block':case'blockItem':return}if(e.attr&&t.attr.push(e.attr),e.data&&t.data.push(e.data),'text'in e){let a=e.text,l=t.childCount;Array.isArray(a)?(t.text.push(...a.map(((e,t)=>({index:t+l,value:e})))),t.childCount+=a.length):(t.text.push({index:l,value:a}),t.childCount+=1)}if(e.style){let a={};for(let t in e.style)a[d(t)]=e.style[t];t.style.push(a)}if(e.styleVar&&t.styleVar.push(e.styleVar),e.visible&&(t.visible=e.visible),e.handler){let t=e.handler;'object'==typeof t.on?_(t.config||{},t.on):_(t)}e.\u0254&&$(e.\u0254)}function V(e,{initCtx:t,runOp:a,hooks:{onMount:l,onState:r}}){let i=e.opsAmount++;l.watch((({value:e,leaf:l})=>{let n=o({value:e,priority:'props',runOp(e){a(e,r)},group:l.root.leafOps[l.fullID].group});l.root.leafOps[l.fullID].group.ops[i]=n;let r=t(e,l)})),r.watch((({value:e,leaf:t})=>{n(e,t.root.leafOps[t.fullID].group.ops[i])}))}function U(e,t,a){e[t].forEach((e=>{F(e,((e,l)=>{switch(t){case'data':case'styleVar':a[t][l]=e;break;case'attr':a.attr['xlink:href'===l?'href':l]=e;break;case'style':l.startsWith('--')?a.styleVar[l.slice(2)]=e:a.style[l]=e}}))}))}function j(e,t,a){let l=e.data.block,n={type:'text',parent:l,visible:0,index:a,value:null};if(l.child[a]=n,e.hydration){let a=O(n);if(a)switch(a.type){case'text':n.value=e.root.env.document.createTextNode(t),a.value.after(n.value);break;case'element':n.value=a.value.nextSibling,y(n.value,t)}else{let e=C(n);n.value=e.firstChild,y(n.value,t)}n.visible=1}else n.value=e.root.env.document.createTextNode(t),M(n);return n}function L(e){let t=e.stateRef,a=Be;a.plain.includes(t)||a.closure.includes(t)||a.closure.push(t)}function z(e,t){let a,r=0,o=0;'function'==typeof t?(r=1,a=t):t&&(o=1,t.fn&&(r=1,a=t.fn),t.\u0254&&('function'==typeof t.\u0254?(r=1,a=t.\u0254):'function'==typeof t.\u0254.fn&&(r=1,a=t.\u0254.fn))),A(Be,'h');let i,s=Be.env,c=Be.namespace,u=c,p='html';u=p='svg'===c?'svg':'html','svg'===e&&(p='svg',u='svg'),Be.isBlock||(i='svg'===p?s.document.createElementNS('http://www.w3.org/2000/svg',e):s.document.createElement(e));let d=i,m={type:'element',tag:e,attr:[],data:[],text:[],style:[],styleVar:[],handler:[],stencil:d,seq:[],staticSeq:[],childTemplates:[],childCount:0,inParentIndex:-1,opsAmount:1,node:[]};'foreignObject'===c?(m.attr.push({xmlns:'http://www.w3.org/1999/xhtml'}),u='html'):'svg'===e?(m.attr.push({xmlns:'http://www.w3.org/2000/svg'}),u='svg'):'foreignObject'===e&&(u='foreignObject');let v=k({name:'element',draft:m,isSvgRoot:'svg'===e,namespace:u,fn(e,{mount:i}){let s=de({named:'domElementCreated'});r&&a(),o&&$(t),ge.unit(m.visible)&&(m.seq.push({type:'visible',value:m.visible}),L(m.visible));let c={attr:{},data:{},style:{},styleVar:{}};U(m,'attr',c),U(m,'data',c),U(m,'style',c),U(m,'styleVar',c),F(c,((e,t)=>{F(e,((e,a)=>{ge.unit(e)?(m.seq.push({type:t,field:a,value:e}),L(e)):m.staticSeq.push({type:t,field:a,value:e})}))})),m.text.forEach((e=>{null!==e.value&&(ge.unit(e.value)?(m.seq.push({type:'dynamicText',value:e.value,childIndex:e.index}),L(e.value)):m.seq.push({type:'staticText',value:String(e.value),childIndex:e.index}))})),m.handler.forEach((e=>{F(e.map,((t,a)=>{m.seq.push({type:'handler',for:a,handler:t,options:e.options,domConfig:e.domConfig})}))})),d&&f(d,m.staticSeq),m.seq.forEach((e=>{switch(e.type){case'visible':{let{onMount:t,onState:a}=E({mount:i,state:e.value,onMount:(e,t)=>({leaf:t,value:e,hydration:t.hydration}),onState:(e,t)=>({leaf:e,value:t,hydration:0})});t.watch((({leaf:e,value:t,hydration:a})=>{let n=e.data,r=n.block;if(a&&(l(t,n.ops.visible),t)){let e,t=q(r);if(e=t?t.nextSibling:C(r).firstChild,'#text'===e.nodeName){let t=e;e=e.nextSibling,t.remove()}r.value=e,r.visible=1}N(m,{parentBlockFragment:r,leaf:e,node:r.value,svgRoot:v.isSvgRoot?r.value:null}),t&&n.needToCallNode&&(n.needToCallNode=0,pe({target:$e,params:{element:n.block.value,fns:m.node},page:e,defer:1,scope:e.root.scope})),pe({target:s,params:e,defer:1,page:e,scope:e.root.scope})})),be([a,t]).watch((({leaf:e,value:t,hydration:a})=>{a||n(t,e.data.ops.visible)}));break}case'attr':case'data':case'style':case'styleVar':{let t=Ue[e.type],a=Ve.some((({type:t,field:a})=>e.type===t&&e.field===a)),l=E({mount:s,state:e.value,onMount:(e,t)=>({leaf:t,value:e}),onState:(e,t)=>({leaf:e,value:t})});a?be([l.onState,l.onMount]).watch((({leaf:a,value:l})=>{t(je(a),e.field,l)})):V(m,{initCtx(a,l){let n=je(l);return t(n,e.field,a),n},runOp(a,l){t(l,e.field,a)},hooks:l});break}case'dynamicText':V(m,{initCtx:(t,a)=>j(a,t,e.childIndex),runOp(e,t){y(t.value,e)},hooks:E({mount:s,state:e.value,onMount:(e,t)=>({leaf:t,value:String(e)}),onState:(e,t)=>({leaf:e,value:String(t)})})});break;case'staticText':s.watch((t=>{j(t,e.value,e.childIndex)}));break;case'handler':{let t=e.handler.graphite.meta.nativeTemplate||null;s.watch((a=>{let l=null;if(t){let e=0,n=a;for(;!e&&n;)n.template===t?(e=1,l=n):n=n.parent}else l=null;je(a).addEventListener(e.for,(t=>{e.options.prevent&&t.preventDefault(),e.options.stop&&t.stopPropagation(),pe({target:e.handler,params:t,page:l,scope:a.root.scope})}),e.domConfig)}));break}}})),i.watch((e=>{let t=e.data;if(!m.visible){let a=t.ops.visible,r=t.block;if(e.hydration){l(1,a);let e,t=q(r);if(e=t?t.nextSibling:C(r).firstChild,'#text'===e.nodeName){let t=e;e=e.nextSibling,t.remove()}r.value=e,r.visible=1}N(m,{parentBlockFragment:r,leaf:e,node:r.value,svgRoot:v.isSvgRoot?r.value:null}),pe({target:s,params:e,defer:1,page:e,scope:e.root.scope}),e.hydration?t.needToCallNode&&(t.needToCallNode=0,pe({target:$e,params:{element:t.block.value,fns:m.node},page:e,defer:1,scope:e.root.scope})):n(1,a)}}))},env:s});P(v)}function G(){if('undefined'!=typeof document)return{document};throw Error('your environment has no document')}function Q(e,t){let a,l,n,r,o,c;if('function'==typeof t)a=t,n=G(),r=0;else{if(!t)throw Error('using() second argument is missing');a=t.fn,n=t.env?t.env:G(),r=t.hydrate,l=t.onComplete,o=t.onRoot,c=t.scope}R(e,'using() first argument is missing');let u={scope:c,env:n,activeSpawns:new Set,childSpawns:{},leafOps:{}},p=e.namespaceURI,d=e.tagName.toLowerCase(),f={type:'using',childTemplates:[],childCount:0,inParentIndex:-1},m=k({name:'using',draft:f,isSvgRoot:'svg'===d,namespace:'http://www.w3.org/2000/svg'===p?'svg':'foreignobject'===d?'foreignObject':'html',fn(e,{mount:t}){a(),t.watch(Le.using)},env:n}),v={type:'using',child:[],value:e},h=i({onComplete:l}),g=D(m,{parentLeaf:Me||null,mountNode:e,svgRoot:m.isSvgRoot?e:Me?Me.svgRoot:null,leafData:{type:'using',draft:f,element:e,block:v},opGroup:s(h),domSubtree:s(h),hydration:r,root:u});if(o&&o({template:m,leaf:g}),h.onDrain&&!h.rafID){let e=h.onDrain;h.onDrain=null,e()}}function W(e,t){let a=e.root.childSpawns[e.fullID];for(let e in a){let l=a[e];for(let e=0;e<l.length;e++)t(l[e])}}function Z(e,t){let a=t=>{let l=t.data;if(e&&'list'===l.type&&l.pendingUpdate){let e=l.pendingUpdate;l.pendingUpdate=null,pe({target:t.template.api.pendingUpdate,params:e,defer:1,page:t,scope:t.root.scope})}if(e&&'route'===l.type)if(l.pendingInit){let e=l.pendingInit.value;l.pendingInit=null,pe({target:t.template.api.pendingInit,params:e,defer:1,page:t,scope:t.root.scope})}else if(!l.block.visible)return;switch(l.type){case'element':n(e,l.ops.visible);break;case'route':case'list':case'list item':W(t,a);break;default:console.log('unsupported type',l.type)}};W(t,a)}function H(e){e.root.activeSpawns.delete(e.fullID),W(e,K)}function J(e){X(e,e.root.childSpawns[e.parent.fullID][e.template.id]),X(e,e.template.pages)}function K(e){let{data:t,root:a}=e;switch(t.type){case'element':X(e,a.childSpawns[e.parent.fullID][e.template.id]),function e(t){a.activeSpawns.delete(t.fullID);let l=a.childSpawns[t.fullID];delete a.childSpawns[t.fullID],delete a.leafOps[t.fullID],X(t,t.template.pages);for(let t in l)l[t].forEach(e)}(e),n(0,t.ops.visible);break;case'list':{let a=t.records;for(let e=0;e<a.length;e++){let t=a[e];t.instance&&K(t.instance),t.active=0}e.root.activeSpawns.delete(e.fullID),J(e);break}case'list item':{let a=t.block;X(a,a.parent.child);let l=a.left,n=a.right;l&&(l.right=n,n||a.parent.lastChild!==a||(a.parent.lastChild=l)),n&&(n.left=l),l||n||a.parent.lastChild!==a||(a.parent.lastChild=null),a.left=null,a.right=null,H(e),J(e);break}case'route':H(e),J(e);break;case'block':case'block item':case'rec':case'rec item':H(e)}delete a.childSpawns[e.fullID],delete a.leafOps[e.fullID]}function X(e,t){if(!t)return;let a=t.indexOf(e);-1!==a&&t.splice(a,1)}function Y(e,t){if(Array.isArray(t))return t.map((t=>e.map((e=>e[t]))));if('object'==typeof t&&null!==t){let a={};for(let l in t){let n=t[l];a[l]=e.map('function'==typeof n?e=>n(e):e=>e[n])}return a}return e.map((e=>e[t]))}function ee(e,t){A(Be,'list'),'function'==typeof t&&(ge.unit(e)?e={source:e,fn:t}:e.fn=t);let{fn:a,key:l,source:n,fields:r=[]}=e,o=void 0!==l?'function'==typeof l?l:e=>e[l]:(e,t)=>t,i={type:'list',key:ge.store(e)?{type:'index'}:{type:'key',key:e.key},childTemplates:[],childCount:0,inParentIndex:-1},{env:d,namespace:f}=Be;P(k({name:'list',draft:i,isSvgRoot:0,namespace:f,fn(e,{mount:t}){let l=k({name:'list item',state:{id:-1,store:null},draft:i,isSvgRoot:0,namespace:f,fn({id:e,store:t},{mount:l}){a({store:t,key:e,fields:Y(t,r)});let n=de({named:'itemUpdater'});if(t.on(n,((e,t)=>t)),i.itemVisible){let{onMount:e,onState:t}=E({mount:l,state:i.itemVisible,onMount:(e,t)=>({visible:e,leaf:t}),onState:(e,t)=>({visible:t,leaf:e})});e.watch((({visible:e,leaf:t})=>{let a=t.data.block;a.visible=e,a.childInitialized=e,e&&N(i,{parentBlockFragment:a,leaf:t})})),t.watch((({visible:e,leaf:t})=>{let a=t.data.block;a.visible=e,a.childInitialized?Z(e,t):e&&(a.childInitialized=1,N(i,{parentBlockFragment:a,leaf:t}))}))}else l.watch(Le.listItem);return{itemUpdater:n}},env:d}),m=ye([]),v=n.map((e=>e)),h=he({source:n,clock:t,fn:(e,t)=>({updates:e,leaf:t,hydration:t.hydration}),greedy:1}),g=de(),b=he({source:h,clock:[v,g],fn:({leaf:e},t)=>({updates:t,leaf:e,hydration:0}),greedy:1});return he({source:m,clock:[h,b],greedy:1,fn(e,{updates:t,leaf:a,hydration:r}){let d=a.data,f=a;for(;f;){if('route'===f.data.type&&!f.data.block.visible)return void(d.pendingUpdate=t);f=f.parent}let m=d.block;Ce('list update ['+n.shortName+']');let v=Array(t.length).fill(0),h=t.map(o),g=[];for(let a=0;a<e.length;a++){let l=e[a],n=h.indexOf(l.key);-1!==n?(g.push(l),v[n]=1,p(t[n],l.asyncValue)):(l.active=0,l.instance&&K(l.instance),u(l.asyncValue))}for(let e=0;e<t.length;e++){if(v[e])continue;let n=t[e],o=h[e],u=s(a.root.leafOps[a.fullID].group.queue),p={type:'LF',parent:m,child:[],childInitialized:0,visible:0,left:null,right:null},d={type:'listItem',key:o,index:o,active:1,leafData:{type:'list item',block:p,listDraft:i},asyncValue:c({value:n,group:u,onChange(e){d.instance&&pe({target:d.instance.template.api.itemUpdater,params:e,defer:1,page:d.instance,scope:d.instance.root.scope})},onInit(e){d.active&&(r||(d.instance=D(l,{values:{id:o,store:e},parentLeaf:a,mountNode:a.mountNode,svgRoot:a.svgRoot,leafData:d.leafData,opGroup:u,domSubtree:a.root.leafOps[a.fullID].domSubtree,hydration:r,root:a.root})))}})},f=g.length;g.push(d);let b=f>0?g[f-1].leafData:null;if(m.child.push(p),b){let e=b.block;p.left=e;let t=e.right;t?(t.left=p,p.right=t):m.lastChild=p,e.right=p}else m.lastChild=p;r&&(d.instance=D(l,{values:{id:o,store:n},parentLeaf:a,mountNode:a.mountNode,svgRoot:a.svgRoot,leafData:d.leafData,opGroup:u,domSubtree:a.root.leafOps[a.fullID].domSubtree,hydration:r,root:a.root}))}return Te('list update ['+n.shortName+']'),0===g.length&&(m.lastChild=null),d.records=g,g},target:m}),{pendingUpdate:g}},env:d}))}function te(e){A(Be,'node');let t=Be.draft;switch(t.type){case'list':case'listItem':case'using':case'route':case'rec':case'recItem':case'block':case'blockItem':return void console.error('node() hook supported only in h() nodes')}t.node.push(e)}function ae({source:e,visible:t,fn:a}){A(Be,'route');let{env:l,namespace:n}=Be,r=k({name:'route',isSvgRoot:0,namespace:n,env:l,draft:{type:'route',childTemplates:[],childCount:0,inParentIndex:-1},fn(r,{mount:o}){let i;if(ge.store(t))i=ke({value:e,visible:t});else{let a=t;i=e.map((e=>({value:e,visible:a(e)})))}let s=k({name:'route item',isSvgRoot:0,namespace:n,env:l,draft:{type:'route',childTemplates:[],childCount:0,inParentIndex:-1},state:{store:null},fn({store:e},{mount:t}){let l=de({named:'itemUpdater'});e.on(l,((e,t)=>t)),a({store:e});let n=he({source:t,clock:i,fn:(e,{visible:t,value:a})=>({leaf:e,visible:t,value:a}),greedy:1});t.watch(Le.routeItem),n.watch((({leaf:e,visible:t,value:a})=>{if(e.data.block.visible=t,t&&pe({target:l,params:a,defer:1,page:e,scope:e.root.scope}),t){let t=e.parent;for(;t;){if('route'===t.data.type&&!t.data.block.visible)return;t=t.parent}}Z(t,e)}))}});P(s);let{onMount:c,onState:u}=E({mount:o,state:i,onMount:({visible:e,value:t},a)=>({leaf:a,visible:e,value:t}),onState:(e,{visible:t,value:a})=>({leaf:e,visible:t,value:a})}),p=de(),d=he({source:o,clock:p,greedy:1,fn:(e,t)=>({leaf:e,value:t,visible:1})});return be([c,u,d]).watch((({leaf:e,visible:t,value:a})=>{let l=e.data;if(l.block.visible=t,t||l.initialized||!l.pendingInit){if(t&&!l.initialized){let t=e.parent;for(;t;){if('route'===t.data.type&&!t.data.block.visible)return void(l.pendingInit={value:a});t=t.parent}}t&&!l.initialized&&(B({parentBlockFragment:l.block,leaf:e,actor:s,values:{store:a}}),l.initialized=1)}else l.pendingInit=null})),{pendingInit:p}}});P(r)}function le({source:e,cases:t,key:a}){let l;A(Be,'variant'),R(ge.unit(e),'variant({source}) should be unit'),l='function'==typeof a?a:null==a?e=>String(e):e=>String(e[a]);let n=0;for(let a in t)'__'!==a?ae({source:e,visible:e=>l(e)===a,fn:t[a]}):n=1;if(n){let a=Object.keys(t);ae({source:e,visible:e=>!a.includes(l(e)),fn:t.__})}}function ne(e){let t='function'==typeof e?e:e.fn,a=k({name:'rec',state:{store:null},isSvgRoot:0,namespace:null,env:null,draft:{type:'rec',childTemplates:[],childCount:0,inParentIndex:0},defer:1,isBlock:1,fn({store:e},{mount:a}){t({store:e,state:e});let l=de({named:'itemUpdater'});return e.on(l,((e,t)=>t)),a.watch(Le.rec),{itemUpdater:l}}});return({store:e,state:t=e})=>{A(Be,'(rec instance)');let{env:l,namespace:n}=Be;a.deferredInit&&a.deferredInit(),P(k({name:'rec item',isSvgRoot:0,namespace:n,env:l,draft:{type:'recItem',childTemplates:[],childCount:0,inParentIndex:-1},fn(e,{mount:l}){let{onMount:n,onState:r}=E({state:t,mount:l,onMount:(e,t)=>({state:e,leaf:t}),onState:(e,t)=>({state:t,leaf:e})});r.watch((({state:e,leaf:t})=>{W(t,(a=>{pe({target:a.template.api.itemUpdater,params:e,defer:1,page:t,scope:t.root.scope})}))})),n.watch((({leaf:e,state:t})=>{B({parentBlockFragment:e.data.block,leaf:e,actor:a,values:{store:t}})}))}}))}}function re({source:e,key:t,child:a,fn:l}){let n=ne((({store:e})=>{ee({source:e,key:t,fn({store:e}){let t=e.map((e=>e[a]||[]));l({store:e,child(){n({store:t})}})}})}));n({store:e})}function oe({fn:e,env:t,namespace:a="html"}){let l=k({name:'block',isSvgRoot:0,namespace:a,env:t,draft:{type:'block',childTemplates:[],childCount:0,inParentIndex:0},isBlock:1,fn({},{mount:t}){e(),t.watch(Le.block)}});return()=>{A(Be,'(block instance)');let e={type:'blockItem',childTemplates:[],childCount:0,inParentIndex:-1,itemOf:l},{env:t,namespace:a}=Be;P(k({name:'block item',isSvgRoot:0,namespace:a,env:t,draft:e,fn(e,{mount:t}){t.watch(Le.blockItem)}}))}}function ie(e,t){if(0===t.length)return e;let a=[e[0]];for(let l=0;l<t.length;l++)a.push(t[l],e[l+1]);return a}function se(e,...t){Array.isArray(e)?$({text:ie(e,t)}):$({text:e})}function ce(e,...t){return t.every((e=>!ge.store(e)))?ie(e,t).join(''):ke(t,(t=>ie(e,t).join('')))}import{step as ue,launch as pe,createEvent as de,createNode as fe,withRegion as me,restore as ve,sample as he,is as ge,merge as be,createStore as ye,combine as ke}from'effector/effector.mjs';let Ie;Ie='undefined'!=typeof performance&&performance.now?()=>performance.now():'undefined'!=typeof process&&process.hrtime?()=>{let e=process.hrtime();return(1e9*e[0]+e[1])/1e6}:()=>Date.now();let xe=new Map;const we=[],Se=e=>{let t=xe.get(e);t||(t={calls:0,time:0,label:e,childTime:0},xe.set(e,t)),t.calls+=1,we.push({bucket:t,pendingStart:Ie()})},De=e=>{let t=xe.get(e),a=we.pop().pendingStart,l=Ie()-a;t.time+=l,we.length>0&&(we[we.length-1].bucket.childTime+=l)};let Ce,Te;'undefined'!=typeof performance&&performance.mark?(Ce=e=>{performance.mark('\u2604\ufe0f '+e+' start'),Se(e)},Te=e=>{De(e);try{performance.measure('\u2604\ufe0f '+e,'\u2604\ufe0f '+e+' start')}catch(e){}performance.clearMarks('\u2604\ufe0f '+e+' start'),performance.clearMeasures('\u2604\ufe0f '+e)}):(Ce=e=>{Se(e)},Te=e=>{De(e)});let Oe='undefined'!=typeof requestAnimationFrame?requestAnimationFrame:e=>setTimeout(e,0);const qe={attr:b,data:g,style:h,styleVar:v},Re=(e,t)=>e.includes(t);let Ae={storeBase(e,t){e.plain.push(t)},storeOnMap(e,t,a,l){var n,r;a.unshift(e.loader),a.push(e.upward),l&&(Re(e.plain,l)||(Re(e.closure,l)||e.closure.push(l),r={type:'closure',of:l},(n=t).before||(n.before=[]),n.before.push(r)))},storeMap(e,t,a){Re(e.plain,t)||Re(a.seq,e.loader)||a.seq.unshift(e.loader)},storeWatch:(e,t,a)=>(e.watch.push({of:t,fn:a}),1),eventPrepend(e,t){t.seq.push(e.upward)},combineBase(e,t,a){e.plain.push(t,a)},combineField(e,t,a){Re(e.plain,t)||a.seq.unshift(e.loader)},splitBase(e,t){e.plain.push(t)},splitMatchStore(e,t,a){Re(e.plain,t)||a.seq.unshift(e.loader)},sampleStoreSource(e,t){Re(e.plain,t)||Re(e.closure,t)||e.closure.push(t)},sampleNonStoreSource(e,t,a,l){e.plain.push(t,a,l)},sampleTarget(e,t){t.seq.push(e.loader)},sampleSourceLoader:e=>e.loader,sampleSourceUpward:(e,t)=>t&&e.upward},Pe=0,Ne=0,Be=null,Me=null;const Ee=(e,t)=>e.reg[t.id];let Fe=null;const _e=['LF','using','element','recItem','rec','block','blockItem','route'];let $e=de({named:'onMount'});$e.watch((({fns:e,element:t})=>{e.forEach((e=>{e(t)}))}));const Ve=[{type:'attr',field:'value'},{type:'attr',field:'checked'},{type:'attr',field:'min'},{type:'attr',field:'max'}],Ue={attr:b,data:g,style:h,styleVar:v},je=e=>e.data.block.value;let Le={using(e){let t=e.data;N(t.draft,{parentBlockFragment:t.block,leaf:e})},routeItem(e){let t=e.draft,a=e.data;a.block.visible=1,N(t,{parentBlockFragment:a.block,leaf:e})},block(e){N(e.draft,{parentBlockFragment:e.data.block,leaf:e})},blockItem(e){B({parentBlockFragment:e.data.block,leaf:e,actor:e.draft.itemOf})},rec(e){N(e.draft,{parentBlockFragment:e.data.block,leaf:e})},listItem(e){let t=e.data,a=t.block;a.visible=1,a.childInitialized=1,N(t.listDraft,{parentBlockFragment:a,leaf:e})}};export{oe as block,z as h,_ as handler,ee as list,te as node,ne as rec,Y as remap,ae as route,$ as spec,se as text,re as tree,Q as using,ce as val,le as variant};
//# sourceMappingURL=forest.mjs.map
